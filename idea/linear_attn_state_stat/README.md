# 稀疏性

首先分析kv state的稀疏性，可以看到稀疏性和kernel函数关系不大。

std = 0.1

| method/feature_dim | 16   | 32   | 64   | 128  | 256  |
|--------------------|------|------|------|------|------|
| identity           | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| silu               | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| relu               | 0.79 | 0.81 | 0.80 | 0.80 | 0.80 |
| elu                | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| 1+elu              | 0.83 | 0.84 | 0.80 | 0.80 | 0.78 |
| sin                | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| cos                | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| exp                | 0.83 | 0.84 | 0.80 | 0.80 | 0.78 |
| feature_softmax    | 0.83 | 0.84 | 0.80 | 0.80 | 0.78 |
| seqlen_softmax     | 0.83 | 0.84 | 0.80 | 0.80 | 0.78 |

std = 0.5

| method/feature_dim | 16   | 32   | 64   | 128  | 256  |
|--------------------|------|------|------|------|------|
| identity           | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| silu               | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |
| relu               | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |
| elu                | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |
| 1+elu              | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |
| sin                | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| cos                | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| exp                | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |
| feature_softmax    | 0.82 | 0.80 | 0.80 | 0.80 | 0.80 |
| seqlen_softmax     | 0.81 | 0.80 | 0.80 | 0.80 | 0.80 |


std = 1

| method/feature_dim | 16   | 32   | 64   | 128  | 256  |
|--------------------|------|------|------|------|------|
| identity           | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| silu               | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| relu               | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| elu                | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| 1+elu              | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |
| sin                | 0.84 | 0.81 | 0.80 | 0.80 | 0.80 |
| cos                | 0.84 | 0.81 | 0.80 | 0.80 | 0.80 |
| exp                | 0.81 | 0.81 | 0.80 | 0.74 | 0.03 |
| feature_softmax    | 0.80 | 0.81 | 0.80 | 0.80 | 0.80 |
| seqlen_softmax     | 0.81 | 0.81 | 0.80 | 0.80 | 0.80 |

# [e-rank](https://core.ac.uk/download/pdf/147929764.pdf)

除了exp-kernel，影响都很小，推测原因是exp-kernel有特别大的异常值。

std = 0.1

| method/feature_dim | 16    | 32    | 64    | 128   | 256    |
|--------------------|-------|-------|-------|-------|--------|
| identity           | 10.51 | 20.44 | 40.54 | 77.16 | 140.11 |
| silu               | 10.50 | 20.44 | 40.56 | 77.15 | 140.25 |
| relu               | 10.35 | 20.46 | 40.16 | 75.58 | 139.23 |
| elu                | 10.51 | 20.45 | 40.55 | 77.16 | 140.15 |
| 1+elu              | 5.18  | 8.66  | 15.78 | 31.49 | 70.59  |
| sin                | 10.51 | 20.45 | 40.54 | 77.16 | 140.12 |
| cos                | 10.51 | 20.45 | 40.54 | 77.16 | 140.12 |
| exp                | 5.23  | 8.81  | 16.23 | 32.75 | 74.05  |
| feature_softmax    | 5.16  | 8.73  | 16.31 | 32.84 | 74.31  |
| seqlen_softmax     | 5.23  | 8.81  | 16.23 | 32.75 | 74.06  |

std = 0.5

| method/feature_dim | 16   | 32    | 64    | 128   | 256    |
|--------------------|------|-------|-------|-------|--------|
| identity           | 9.83 | 21.11 | 40.01 | 76.45 | 139.76 |
| silu               | 9.86 | 21.11 | 39.76 | 76.05 | 138.89 |
| relu               | 9.84 | 20.95 | 39.54 | 75.48 | 137.69 |
| elu                | 9.90 | 21.20 | 39.98 | 76.53 | 139.73 |
| 1+elu              | 9.66 | 20.55 | 39.07 | 74.33 | 134.94 |
| sin                | 9.96 | 21.25 | 40.75 | 82.76 | 159.69 |
| cos                | 9.96 | 21.25 | 40.75 | 82.76 | 159.69 |
| exp                | 9.35 | 19.66 | 29.52 | 24.27 | 59.02  |
| feature_softmax    | 9.80 | 20.99 | 39.88 | 77.51 | 147.70 |
| seqlen_softmax     | 9.73 | 20.91 | 39.09 | 76.33 | 148.57 |


std = 1

| method/feature_dim | 16    | 32    | 64    | 128   | 256    |
|--------------------|-------|-------|-------|-------|--------|
| identity           | 9.96  | 19.73 | 39.71 | 77.49 | 139.75 |
| silu               | 9.91  | 19.68 | 39.57 | 76.43 | 137.77 |
| relu               | 9.91  | 19.68 | 39.56 | 76.37 | 137.65 |
| elu                | 9.97  | 19.72 | 39.68 | 76.80 | 138.51 |
| 1+elu              | 9.96  | 19.70 | 39.53 | 76.16 | 137.02 |
| sin                | 10.36 | 20.95 | 41.38 | 82.96 | 160.80 |
| cos                | 10.36 | 20.95 | 41.38 | 82.96 | 160.80 |
| exp                | 2.73  | 3.28  | 1.11  | 3.12  | 1.01   |
| feature_softmax    | 9.86  | 19.74 | 39.19 | 78.77 | 148.60 |
| seqlen_softmax     | 10.02 | 20.40 | 38.98 | 78.33 | 144.37 |

# e-rank Vs decay rate

kernel = identity, std = 1, 测试decay rate和e-rank的关系, 可以看到decay越接近于1, e-rank越大, 符合左乘的理解。

sparse:

| feature_dim/decay_rate | 0.5  | 0.75 | 0.9  | 0.95 | 0.99 | 0.999 | 1    |
|------------------------|------|------|------|------|------|-------|------|
| 16                     | 0.78 | 0.80 | 0.82 | 0.83 | 0.80 | 0.79  | 0.80 |
| 32                     | 0.80 | 0.80 | 0.80 | 0.81 | 0.81 | 0.80  | 0.80 |
| 64                     | 0.80 | 0.81 | 0.81 | 0.81 | 0.80 | 0.80  | 0.81 |
| 128                    | 0.80 | 0.80 | 0.80 | 0.80 | 0.80 | 0.80  | 0.80 |
| 256                    | 0.80 | 0.80 | 0.80 | 0.80 | 0.80 | 0.80  | 0.80 |

e-rank:
| feature_dim/decay_rate | 0.5  | 0.75 | 0.9   | 0.95  | 0.99   | 0.999  | 1      |
|------------------------|------|------|-------|-------|--------|--------|--------|
| 16                     | 3.51 | 5.51 | 8.20  | 8.29  | 9.91   | 10.51  | 10.40  |
| 32                     | 3.08 | 7.49 | 13.34 | 15.73 | 19.41  | 20.59  | 21.39  |
| 64                     | 3.93 | 7.58 | 18.20 | 25.44 | 37.06  | 40.32  | 40.40  |
| 128                    | 3.63 | 8.55 | 20.66 | 33.92 | 66.82  | 76.33  | 75.77  |
| 256                    | 3.94 | 9.25 | 23.66 | 43.17 | 109.73 | 139.84 | 140.82 |
